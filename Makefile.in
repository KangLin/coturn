
LIBEVENT_INCLUDE = -I${PREFIX}/include/ -I/usr/local/include/

INCFLAGS = -Isrc -Isrc/apps/common -Isrc/server -Isrc/client -Isrc/client++ ${LIBEVENT_INCLUDE} 

CFLAGS += ${INCFLAGS} ${DBCFLAGS}
CPPFLAGS += ${INCFLAGS} ${DBCFLAGS}

MAKE_DEPS = Makefile

BUILD_DIR = build
LIB_DIR = ${BUILD_DIR}/lib
BIN_DIR = ${BUILD_DIR}/bin

TURN_BUILD_RESULTS = ${BIN_DIR}/turnutils_uclient ${BIN_DIR}/turnutils_natdiscovery ${BIN_DIR}/turnutils_oauth ${BIN_DIR}/turnutils_stunclient ${BIN_DIR}/turnutils_rfc5769check ${BIN_DIR}/turnserver ${BIN_DIR}/turnutils_peer include/turn/ns_turn_defs.h sqlite_empty_db

.PHONY: all test check clean distclean install deinstall uninstall reinstall

all:	${TURN_BUILD_RESULTS}

test:	check

check:	${BIN_DIR}/turnutils_rfc5769check
	${BIN_DIR}/turnutils_rfc5769check

format:
	find . -iname "*.c" -o -iname "*.h" | xargs clang-format -i

lint:
	find . -iname "*.c" -o -iname "*.h" | xargs clang-format --dry-run -Werror

include/turn/ns_turn_defs.h:	src/ns_turn_defs.h
	${RMCMD} include
	${MKBUILDDIR} include/turn/client
	cp -pf src/client/*.h include/turn/client/
	cp -pf src/client++/*.h include/turn/client/
	cp -pf src/ns_turn_defs.h include/turn/

# Build for C source
$(BUILD_DIR)/%.c.o: %.c
	${MKBUILDDIR} $(dir $@)
	$(CC) $(CPPFLAGS) $(CFLAGS) -c $< -o $@

# Build for C++ source
$(BUILD_DIR)/%.cpp.o: %.cpp
	${MKBUILDDIR} $(dir $@)
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c $< -o $@

LOG4CPLUS_SOURCE := $(if ${HAS_LOG4CPLUS},src/apps/common/log4cplus.cpp,)
COMMON_HEADERS = src/apps/common/apputils.h src/apps/common/ns_turn_openssl.h src/apps/common/ns_turn_utils.h src/apps/common/stun_buffer.h
COMMON_SOURCE := src/apps/common/apputils.c src/apps/common/ns_turn_utils.c src/apps/common/stun_buffer.c ${LOG4CPLUS_SOURCE}
COMMON_OBJS := $(COMMON_SOURCE:%=$(BUILD_DIR)/%.o)

LIBCLIENTTURN_HEADERS = src/ns_turn_defs.h src/client++/TurnMsgLib.h src/client/ns_turn_ioaddr.h src/client/ns_turn_msg.h src/client/ns_turn_msg_defs.h src/client/ns_turn_msg_defs_experimental.h src/client/ns_turn_msg_addr.h
LIBCLIENTTURN_SOURCE = src/client/ns_turn_ioaddr.c src/client/ns_turn_msg_addr.c src/client/ns_turn_msg.c 
LIBCLIENTTURN_DEPS = ${LIBCLIENTTURN_HEADERS} ${MAKE_DEPS} 
LIBCLIENTTURN_OBJS := $(LIBCLIENTTURN_SOURCE:%=$(BUILD_DIR)/%.o) ${COMMON_OBJS}

SERVERTURN_HEADERS = src/server/ns_turn_allocation.h src/server/ns_turn_ioalib.h src/server/ns_turn_khash.h src/server/ns_turn_maps_rtcp.h src/server/ns_turn_maps.h src/server/ns_turn_server.h src/server/ns_turn_session.h 
SERVERTURN_DEPS = ${LIB_DIR}/libturnclient.a
SERVERTURN_SOURCE = src/server/ns_turn_allocation.c src/server/ns_turn_maps_rtcp.c src/server/ns_turn_maps.c src/server/ns_turn_server.c
SERVERTURN_OBJS = $(SERVERTURN_SOURCE:%=$(BUILD_DIR)/%.o)

### Libraries:
${LIB_DIR}/libturnclient.a: ${LIBCLIENTTURN_OBJS} ${LIBCLIENTTURN_DEPS}
	${MKBUILDDIR} ${LIB_DIR}
	${ARCHIVERCMD} $@ ${LIBCLIENTTURN_OBJS}

${LIB_DIR}/libturnserver.a: ${SERVERTURN_OBJS} ${SERVERTURN_DEPS}
	${MKBUILDDIR} ${LIB_DIR}
	${ARCHIVERCMD} $@ ${SERVERTURN_OBJS}

### Applications
# turnserver
IMPL_HEADERS = src/apps/relay/ns_ioalib_impl.h src/apps/relay/ns_sm.h src/apps/relay/turn_ports.h
IMPL_SOURCE = src/apps/relay/ns_ioalib_engine_impl.c src/apps/relay/turn_ports.c src/apps/relay/http_server.c src/apps/relay/acme.c
IMPL_DEPS = ${IMPL_HEADERS} ${IMPL_SOURCE}

HIREDIS_HEADERS = src/apps/common/hiredis_libevent2.h
HIREDIS_SOURCE = src/apps/common/hiredis_libevent2.c

USERDB_HEADERS = src/apps/relay/dbdrivers/dbdriver.h src/apps/relay/dbdrivers/dbd_sqlite.h src/apps/relay/dbdrivers/dbd_pgsql.h src/apps/relay/dbdrivers/dbd_mysql.h src/apps/relay/dbdrivers/dbd_mongo.h src/apps/relay/dbdrivers/dbd_redis.h
USERDB_SOURCE = src/apps/relay/dbdrivers/dbdriver.c src/apps/relay/dbdrivers/dbd_sqlite.c src/apps/relay/dbdrivers/dbd_pgsql.c src/apps/relay/dbdrivers/dbd_mysql.c src/apps/relay/dbdrivers/dbd_mongo.c src/apps/relay/dbdrivers/dbd_redis.c

SERVERAPP_HEADERS = src/apps/relay/userdb.h src/apps/relay/tls_listener.h src/apps/relay/mainrelay.h src/apps/relay/turn_admin_server.h src/apps/relay/dtls_listener.h src/apps/relay/libtelnet.h src/apps/relay/prom_server.h ${HIREDIS_HEADERS} ${USERDB_HEADERS}
SERVERAPP_SOURCE = src/apps/relay/mainrelay.c src/apps/relay/netengine.c src/apps/relay/libtelnet.c src/apps/relay/turn_admin_server.c src/apps/relay/userdb.c src/apps/relay/tls_listener.c src/apps/relay/dtls_listener.c src/apps/relay/prom_server.c ${HIREDIS_SOURCE} ${USERDB_SOURCE} ${IMPL_SOURCE}
SERVERAPP_OBJ :=$(SERVERAPP_SOURCE:%=$(BUILD_DIR)/%.o)
SERVERAPP_DEPS = ${LIB_DIR}/libturnserver.a ${LIB_DIR}/libturnclient.a
${BIN_DIR}/turnserver: ${SERVERAPP_OBJ} ${SERVERAPP_DEPS}
	${MKBUILDDIR} ${BIN_DIR}
	${RMCMD} ${BIN_DIR}/turnadmin
	$(CXX) $(SERVERAPP_OBJ) -o $@ ${SERVERAPP_DEPS} ${LDFLAGS} ${DBLIBS}
	cd ${BIN_DIR} && ln -s turnserver turnadmin

# turnutils_uclient
turnutils_uclient_SRC = src/apps/uclient/uclient.c src/apps/uclient/startuclient.c src/apps/uclient/mainuclient.c
turnutils_uclient_OBJ := $(turnutils_uclient_SRC:%=$(BUILD_DIR)/%.o)
turnutils_uclient_DEPS := ${LIB_DIR}/libturnclient.a
${BIN_DIR}/turnutils_uclient: ${turnutils_uclient_OBJ} ${turnutils_uclient_DEPS}
	pwd
	${MKBUILDDIR} ${BIN_DIR}
	$(CXX) $(turnutils_uclient_OBJ) -o $@ ${turnutils_uclient_DEPS} ${LDFLAGS}

# turnutils_natdiscovery
turnutils_natdiscovery_SRC = src/apps/natdiscovery/natdiscovery.c
turnutils_natdiscovery_OBJ := $(turnutils_natdiscovery_SRC:%=$(BUILD_DIR)/%.o)
turnutils_natdiscovery_DEPS := ${LIB_DIR}/libturnclient.a
${BIN_DIR}/turnutils_natdiscovery: ${turnutils_natdiscovery_OBJ} ${turnutils_natdiscovery_DEPS}
	pwd
	${MKBUILDDIR} ${BIN_DIR}
	$(CXX) $(turnutils_natdiscovery_OBJ) -o $@ ${turnutils_uclient_DEPS} ${LDFLAGS}

# turnutils_oauth
turnutils_oauth_SRC = src/apps/oauth/oauth.c
turnutils_oauth_OBJ := $(turnutils_oauth_SRC:%=$(BUILD_DIR)/%.o)
turnutils_oauth_DEPS := ${LIB_DIR}/libturnclient.a
${BIN_DIR}/turnutils_oauth:	${turnutils_oauth_OBJ} ${turnutils_oauth_DEPS}
	pwd
	${MKBUILDDIR} ${BIN_DIR}
	$(CXX) $(turnutils_oauth_OBJ) -o $@ ${turnutils_oauth_DEPS} ${LDFLAGS}

# turnutils_stunclient
turnutils_stunclient_SRC = src/apps/stunclient/stunclient.c
turnutils_stunclient_OBJ := $(turnutils_stunclient_SRC:%=$(BUILD_DIR)/%.o)
turnutils_stunclient_DEPS := ${LIB_DIR}/libturnclient.a
${BIN_DIR}/turnutils_stunclient: ${turnutils_stunclient_OBJ} ${turnutils_stunclient_DEPS}
	pwd
	${MKBUILDDIR} ${BIN_DIR}
	$(CXX) $(turnutils_oauth_OBJ) -o $@ ${turnutils_oauth_DEPS} ${LDFLAGS}

# turnutils_rfc5769check
turnutils_rfc5769check_SRC = src/apps/rfc5769/rfc5769check.c
turnutils_rfc5769check_OBJ := $(turnutils_rfc5769check_SRC:%=$(BUILD_DIR)/%.o)
turnutils_rfc5769check_DEPS := ${LIB_DIR}/libturnclient.a
${BIN_DIR}/turnutils_rfc5769check:	${turnutils_rfc5769check_OBJ} ${turnutils_rfc5769check_DEPS}
	pwd
	${MKBUILDDIR} ${BIN_DIR}
	$(CXX) $(turnutils_rfc5769check_OBJ) -o $@ ${turnutils_oauth_DEPS} ${LDFLAGS}

# turnutils_peer
turnutils_peer_SRC = src/apps/peer/mainudpserver.c src/apps/peer/udpserver.c 
turnutils_peer_OBJ := $(turnutils_peer_SRC:%=$(BUILD_DIR)/%.o)
turnutils_peer_DEPS := ${LIB_DIR}/libturnclient.a
${BIN_DIR}/turnutils_peer:	${turnutils_peer_OBJ} ${turnutils_peer_DEPS}
	${MKBUILDDIR} ${BIN_DIR}
	$(CXX) $(turnutils_peer_OBJ) -o $@ ${turnutils_peer_DEPS} ${LDFLAGS}

### Clean all:

clean:	
	${RMCMD} ${BIN_DIR} build lib obj *bak *~ */*~ */*/*~ */*/*/*~ *core */*core */*/*core include tmp sqlite

distclean:	clean
	${RMCMD} Makefile

### SQLite empty database:
sqlite_empty_db	:	sqlite/turndb

sqlite/turndb	:	turndb/schema.sql
	${MKDIR} sqlite
	${RMCMD} sqlite/turndb
	${SQLITE_CMD} sqlite/turndb < turndb/schema.sql

### Install all:

install:	all ${MAKE_DEPS}
	${MKDIR} ${DESTDIR}${PREFIX}
	${MKDIR} ${DESTDIR}${BINDIR}
	${MKDIR} ${DESTDIR}${TURNDBDIR}
	${MKDIR} ${DESTDIR}${MANPREFIX}/man/man1
	${MKDIR} ${DESTDIR}${CONFDIR}
	${MKDIR} ${DESTDIR}${LIBDIR}
	${MKDIR} ${DESTDIR}${EXAMPLESDIR}
	${MKDIR} ${DESTDIR}${DOCSDIR}
	${MKDIR} ${DESTDIR}${SCHEMADIR}
	${MKDIR} ${DESTDIR}${TURNINCLUDEDIR}
	${INSTALL_PROGRAM} ${BIN_DIR}/turnserver ${DESTDIR}${BINDIR}
	${INSTALL_PROGRAM} ${BIN_DIR}/turnadmin ${DESTDIR}${BINDIR}
	${INSTALL_PROGRAM} ${BIN_DIR}/turnutils_uclient ${DESTDIR}${BINDIR}
	${INSTALL_PROGRAM} ${BIN_DIR}/turnutils_peer ${DESTDIR}${BINDIR}
	${INSTALL_PROGRAM} ${BIN_DIR}/turnutils_stunclient ${DESTDIR}${BINDIR}
	${INSTALL_PROGRAM} ${BIN_DIR}/turnutils_oauth ${DESTDIR}${BINDIR}
	${INSTALL_PROGRAM} ${BIN_DIR}/turnutils_natdiscovery ${DESTDIR}${BINDIR}
	${INSTALL_MAN} man/man1/turnserver.1 ${DESTDIR}${MANPREFIX}/man/man1/
	${INSTALL_MAN} man/man1/turnadmin.1 ${DESTDIR}${MANPREFIX}/man/man1/
	${INSTALL_MAN} man/man1/turnutils.1 ${DESTDIR}${MANPREFIX}/man/man1/
	${INSTALL_MAN} man/man1/turnutils_uclient.1 ${DESTDIR}${MANPREFIX}/man/man1/
	${INSTALL_MAN} man/man1/turnutils_stunclient.1 ${DESTDIR}${MANPREFIX}/man/man1/
	${INSTALL_MAN} man/man1/turnutils_oauth.1 ${DESTDIR}${MANPREFIX}/man/man1/
	${INSTALL_MAN} man/man1/turnutils_natdiscovery.1 ${DESTDIR}${MANPREFIX}/man/man1/
	${INSTALL_MAN} man/man1/turnutils_peer.1 ${DESTDIR}${MANPREFIX}/man/man1/
	${INSTALL_MAN} man/man1/coturn.1 ${DESTDIR}${MANPREFIX}/man/man1/
	${INSTALL_STATIC_LIB} ${LIB_DIR}/libturnclient.a ${DESTDIR}${LIBDIR}
	${INSTALL_STATIC_LIB} ${LIB_DIR}/libturnserver.a ${DESTDIR}${LIBDIR}
	${INSTALL_DATA} LICENSE ${DESTDIR}${DOCSDIR}
	${INSTALL_DATA} README.turnserver ${DESTDIR}${DOCSDIR}
	${INSTALL_DATA} README.turnadmin ${DESTDIR}${DOCSDIR}
	${INSTALL_DATA} README.turnutils ${DESTDIR}${DOCSDIR}
	${INSTALL_DATA} INSTALL ${DESTDIR}${DOCSDIR}
	${INSTALL_DATA} postinstall.txt ${DESTDIR}${DOCSDIR}
	${INSTALL_DATA} turndb/schema.sql ${DESTDIR}${DOCSDIR}
	${INSTALL_DATA} turndb/schema.sql ${DESTDIR}${SCHEMADIR}
	${INSTALL_DATA} turndb/schema.mongo.sh ${DESTDIR}${DOCSDIR}
	${INSTALL_DATA} turndb/schema.mongo.sh ${DESTDIR}${SCHEMADIR}
	${INSTALL_DATA} turndb/testredisdbsetup.sh ${DESTDIR}${SCHEMADIR}
	${INSTALL_DATA} turndb/testmongosetup.sh ${DESTDIR}${SCHEMADIR}
	${INSTALL_DATA} turndb/testsqldbsetup.sql ${DESTDIR}${SCHEMADIR}
	${INSTALL_DATA} turndb/schema.userdb.redis ${DESTDIR}${DOCSDIR}
	${INSTALL_DATA} turndb/schema.userdb.redis ${DESTDIR}${SCHEMADIR}
	${INSTALL_DATA} turndb/schema.stats.redis ${DESTDIR}${DOCSDIR}
	${INSTALL_DATA} turndb/schema.stats.redis ${DESTDIR}${SCHEMADIR}
	if [ -f sqlite/turndb ] ; then ${INSTALL_DATA} sqlite/turndb ${DESTDIR}${TURNDBDIR}/turndb; fi
	${INSTALL_DATA} examples/etc/turnserver.conf ${DESTDIR}${CONFDIR}/turnserver.conf.default
	${INSTALL_DATA} examples/etc/log.conf ${DESTDIR}${CONFDIR}/turnserver_log.conf
	${INSTALL_DIR} examples/etc ${DESTDIR}${EXAMPLESDIR}
	${INSTALL_DIR} examples/scripts ${DESTDIR}${EXAMPLESDIR}
	${RMCMD} ${DESTDIR}${EXAMPLESDIR}/scripts/rfc5769.sh
	${INSTALL_DIR} include/turn/client ${DESTDIR}${TURNINCLUDEDIR}
	${INSTALL_DATA} include/turn/ns_turn_defs.h ${DESTDIR}${TURNINCLUDEDIR}
	${MORECMD} ${DESTDIR}${DOCSDIR}/postinstall.txt

deinstall:	${MAKE_DEPS}
	${PKILL_PROGRAM} turnserver || ${ECHO_CMD} OK
	${RMCMD} ${DESTDIR}${TURNDBDIR}/turndb
	${RMCMD} ${DESTDIR}${DOCSDIR}
	${RMCMD} ${DESTDIR}${SCHEMADIR}
	${RMCMD} ${DESTDIR}${BINDIR}/turnserver
	${RMCMD} ${DESTDIR}${BINDIR}/turnadmin
	${RMCMD} ${DESTDIR}${BINDIR}/turnutils_peer
	${RMCMD} ${DESTDIR}${BINDIR}/turnutils_uclient
	${RMCMD} ${DESTDIR}${BINDIR}/turnutils_stunclient
	${RMCMD} ${DESTDIR}${BINDIR}/turnutils_oauth
	${RMCMD} ${DESTDIR}${BINDIR}/turnutils_natdiscovery
	${RMCMD} ${DESTDIR}${MANPREFIX}/man/man1/turnserver.1
	${RMCMD} ${DESTDIR}${MANPREFIX}/man/man1/turnadmin.1
	${RMCMD} ${DESTDIR}${MANPREFIX}/man/man1/turnutils.1
	${RMCMD} ${DESTDIR}${MANPREFIX}/man/man1/turnutils_uclient.1
	${RMCMD} ${DESTDIR}${MANPREFIX}/man/man1/turnutils_stunclient.1
	${RMCMD} ${DESTDIR}${MANPREFIX}/man/man1/turnutils_oauth.1
	${RMCMD} ${DESTDIR}${MANPREFIX}/man/man1/turnutils_natdiscovery.1
	${RMCMD} ${DESTDIR}${MANPREFIX}/man/man1/turnutils_peer.1
	${RMCMD} ${DESTDIR}${MANPREFIX}/man/man1/coturn.1
	${RMCMD} ${DESTDIR}${LIBDIR}/libturnclient.a
	${RMCMD} ${DESTDIR}${LIBDIR}/libturnserver.a 
	${RMCMD} ${DESTDIR}${EXAMPLESDIR}
	${RMCMD} ${DESTDIR}${CONFDIR}/turnserver.conf.default
	${RMCMD} ${DESTDIR}${CONFDIR}/turnserver_log.conf
	${RMCMD} ${DESTDIR}${TURNINCLUDEDIR}

uninstall:	deinstall

reinstall:	deinstall install
